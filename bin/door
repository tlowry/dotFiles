#!/bin/sh
[ -z "$1" ] && echo "use: door <remote_machine_name> <user_name>" && exit 1

mk_key () {
    ssh-keygen -t rsa -q -f "$1" -N ""
    chmod 400 "$1"
    eval $(ssh-agent)
    ssh-add
}

RUSER="$USER"
[ -z "$2" ] || RUSER="$2"
key="$HOME/.ssh/id_rsa"
[ -f "$key" ] || mk_key "$key"  

keyc=`cat "$key.pub"`
remfile=".ssh/authorized_keys"
ssh "$RUSER@$1" "grep -qxF \"$keyc\" "$remfile" || echo "$keyc" >> "$remfile""
